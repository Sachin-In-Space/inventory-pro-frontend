<div class="flex h-screen bg-secondary dark:bg-base-dark font-sans">
  @if (!authService.user()) {
  <app-login></app-login>
  } @else {
  <!-- Desktop Sidebar -->
  <aside
    class="hidden w-64 flex-shrink-0 bg-card dark:bg-card-dark border-r border-border-light dark:border-border-dark md:flex flex-col">
    <div class="h-16 flex items-center px-6 border-b border-border-light dark:border-border-dark">
      <h1 class="text-2xl font-bold text-text-main dark:text-text-dark">Inventory<span class="text-primary">Pro</span>
      </h1>
    </div>
    <nav class="flex-1 px-4 py-4 space-y-1">
      <a (click)="setView('dashboard')" [ngClass]="{
          'bg-primary-light dark:bg-primary/20 text-primary dark:text-text-dark': currentView() === 'dashboard',
          'text-text-muted dark:text-text-muted-dark': currentView() !== 'dashboard'
        }"
        class="flex items-center px-3 py-2.5 text-sm font-medium rounded-lg hover:bg-primary-light dark:hover:bg-primary/10 hover:text-primary dark:hover:text-text-dark transition-colors duration-200 cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" />
        </svg>
        Dashboard
      </a>
      @if (userService.hasPermission('viewProducts')) {
      <a (click)="setView('products')" [ngClass]="{
          'bg-primary-light dark:bg-primary/20 text-primary dark:text-text-dark': currentView() === 'products',
          'text-text-muted dark:text-text-muted-dark': currentView() !== 'products'
        }"
        class="flex items-center px-3 py-2.5 text-sm font-medium rounded-lg hover:bg-primary-light dark:hover:bg-primary/10 hover:text-primary dark:hover:text-text-dark transition-colors duration-200 cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M20.25 7.5l-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" />
        </svg>
        Products
      </a>
      }
      @if (userService.hasPermission('viewOrders')) {
      <a (click)="setView('orders')" [ngClass]="{
          'bg-primary-light dark:bg-primary/20 text-primary dark:text-text-dark': currentView() === 'orders',
          'text-text-muted dark:text-text-muted-dark': currentView() !== 'orders'
        }"
        class="flex items-center px-3 py-2.5 text-sm font-medium rounded-lg hover:bg-primary-light dark:hover:bg-primary/10 hover:text-primary dark:hover:text-text-dark transition-colors duration-200 cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M3.75 9.75h16.5m-16.5 0a2.25 2.25 0 0 1-2.25-2.25V5.25A2.25 2.25 0 0 1 3.75 3h16.5a2.25 2.25 0 0 1 2.25 2.25v2.25a2.25 2.25 0 0 1-2.25 2.25m-16.5 0v11.25c0 1.242 1.008 2.25 2.25 2.25h12c1.242 0 2.25-1.008 2.25-2.25V9.75" />
        </svg>
        Orders
      </a>
      }
      @if (userService.hasPermission('viewReports')) {
      <a (click)="setView('reports')" [ngClass]="{
          'bg-primary-light dark:bg-primary/20 text-primary dark:text-text-dark': currentView() === 'reports',
          'text-text-muted dark:text-text-muted-dark': currentView() !== 'reports'
        }"
        class="flex items-center px-3 py-2.5 text-sm font-medium rounded-lg hover:bg-primary-light dark:hover:bg-primary/10 hover:text-primary dark:hover:text-text-dark transition-colors duration-200 cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
        </svg>
        Reports
      </a>
      }
      @if (userService.hasPermission('viewLogs')) {
      <a (click)="setView('logs')" [ngClass]="{
          'bg-primary-light dark:bg-primary/20 text-primary dark:text-text-dark': currentView() === 'logs',
          'text-text-muted dark:text-text-muted-dark': currentView() !== 'logs'
        }"
        class="flex items-center px-3 py-2.5 text-sm font-medium rounded-lg hover:bg-primary-light dark:hover:bg-primary/10 hover:text-primary dark:hover:text-text-dark transition-colors duration-200 cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" />
        </svg>
        Audit Logs
      </a>
      }
      @if (userService.hasPermission('manageSettings')) {
      <a (click)="setView('settings')" [ngClass]="{
          'bg-primary-light dark:bg-primary/20 text-primary dark:text-text-dark': currentView() === 'settings',
          'text-text-muted dark:text-text-muted-dark': currentView() !== 'settings'
        }"
        class="flex items-center px-3 py-2.5 text-sm font-medium rounded-lg hover:bg-primary-light dark:hover:bg-primary/10 hover:text-primary dark:hover:text-text-dark transition-colors duration-200 cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" />
        </svg>
        Settings
      </a>
      }
    </nav>
    <div class="mt-auto px-4 py-4 border-t border-border-light dark:border-border-dark">
      <label for="role-switcher"
        class="block text-xs font-medium text-text-muted dark:text-text-muted-dark mb-2">Simulate User Role</label>
      <select id="role-switcher" (change)="initiateRoleSwitch($any($event.target).value)" [ngModel]="currentUser().role"
        class="block w-full text-sm px-3 py-2 bg-card dark:bg-card-dark border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary">
        <option value="Admin">Admin</option>
        <option value="Captain">Captain</option>
        <option value="Delivery">Delivery</option>
        <option value="InventoryManager">Inventory Manager</option>
        <option value="Viewer">Read-only Viewer</option>
      </select>
      <div class="mt-4 p-3 bg-secondary dark:bg-base-dark rounded-lg flex items-center justify-between group">
        <div>
          <p class="text-sm font-semibold text-text-main dark:text-text-dark">{{ currentUser().name }}</p>
          <p class="text-xs text-text-muted dark:text-text-muted-dark">{{ currentUser().role }}</p>
        </div>
        <button (click)="logout()"
          class="p-1.5 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 text-text-muted dark:text-text-muted-dark hover:text-red-500 transition-colors"
          title="Sign out">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
            stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" />
          </svg>
        </button>
      </div>
    </div>
  </aside>

  <!-- Main content -->
  <div class="flex flex-col flex-1">
    <!-- Header for Mobile -->
    <header
      class="sticky top-0 z-20 flex items-center justify-between h-16 px-4 bg-card/80 dark:bg-card-dark/80 backdrop-blur-lg border-b border-border-light dark:border-border-dark md:hidden">
      <h1 class="text-xl font-bold text-text-main dark:text-text-dark">Inventory<span class="text-primary">Pro</span>
      </h1>
      <div class="relative">
        <button (click)="showRoleSwitcherMobile.set(!showRoleSwitcherMobile())"
          class="p-2 rounded-full text-text-muted dark:text-text-muted-dark hover:bg-secondary dark:hover:bg-base-dark focus:outline-none focus:ring-2 focus:ring-primary">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
          </svg>
        </button>

        @if (showRoleSwitcherMobile()) {
        <div
          class="absolute right-0 mt-2 w-64 origin-top-right bg-card dark:bg-card-dark rounded-md shadow-2xl ring-1 ring-black ring-opacity-5 focus:outline-none z-30">
          <div class="p-4">
            <label for="role-switcher-mobile"
              class="block text-xs font-medium text-text-muted dark:text-text-muted-dark mb-2">Simulate User
              Role</label>
            <select id="role-switcher-mobile"
              (change)="initiateRoleSwitch($any($event.target).value); showRoleSwitcherMobile.set(false)"
              [ngModel]="currentUser().role"
              class="block w-full text-sm px-3 py-2 bg-secondary dark:bg-base-dark border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary">
              <option value="Admin">Admin</option>
              <option value="Captain">Captain</option>
              <option value="Delivery">Delivery</option>
              <option value="InventoryManager">Inventory Manager</option>
              <option value="Viewer">Read-only Viewer</option>
            </select>
            <div class="mt-4 p-3 bg-secondary dark:bg-base-dark rounded-lg flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-text-main dark:text-text-dark">{{ currentUser().name }}</p>
                <p class="text-xs text-text-muted dark:text-text-muted-dark">{{ currentUser().role }}</p>
              </div>
              <button (click)="logout()"
                class="p-1.5 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 text-text-muted dark:text-text-muted-dark hover:text-red-500 transition-colors"
                title="Sign out">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" />
                </svg>
              </button>
            </div>
          </div>
        </div>
        }
      </div>
    </header>

    <main class="flex-1 overflow-y-auto pb-16 md:pb-0">
      <div class="p-4 sm:p-6 md:p-8">
        @switch (currentView()) {
        @case ('dashboard') { <app-dashboard></app-dashboard> }
        @case ('products') { <app-products></app-products> }
        @case ('orders') { <app-orders></app-orders> }
        @case ('reports') { <app-reports></app-reports> }
        @case ('logs') { <app-audit-log></app-audit-log> }
        @case ('settings') { <app-settings></app-settings> }
        }
      </div>
    </main>
  </div>

  <!-- Bottom Navigation for Mobile -->
  <nav
    class="md:hidden fixed bottom-0 left-0 right-0 z-40 bg-card/80 dark:bg-card-dark/80 backdrop-blur-lg border-t border-border-light dark:border-border-dark shadow-[0_-2px_5px_rgba(0,0,0,0.05)]">
    <div class="flex justify-around items-center h-16">
      <a (click)="setView('dashboard')"
        class="flex flex-col items-center justify-center w-full h-full pt-2 text-center cursor-pointer transition-colors duration-200 hover:text-primary"
        [class.text-primary]="currentView() === 'dashboard'" [class.text-text-muted]="currentView() !== 'dashboard'"
        [class.dark:text-text-muted-dark]="currentView() !== 'dashboard'">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mb-1" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" />
        </svg>
        <span class="text-xs font-medium">Dashboard</span>
      </a>
      @if (userService.hasPermission('viewProducts')) {
      <a (click)="setView('products')"
        class="flex flex-col items-center justify-center w-full h-full pt-2 text-center cursor-pointer transition-colors duration-200 hover:text-primary"
        [class.text-primary]="currentView() === 'products'" [class.text-text-muted]="currentView() !== 'products'"
        [class.dark:text-text-muted-dark]="currentView() !== 'products'">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mb-1" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M20.25 7.5l-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" />
        </svg>
        <span class="text-xs font-medium">Products</span>
      </a>
      }
      @if (userService.hasPermission('viewOrders')) {
      <a (click)="setView('orders')"
        class="flex flex-col items-center justify-center w-full h-full pt-2 text-center cursor-pointer transition-colors duration-200 hover:text-primary"
        [class.text-primary]="currentView() === 'orders'" [class.text-text-muted]="currentView() !== 'orders'"
        [class.dark:text-text-muted-dark]="currentView() !== 'orders'">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mb-1" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M3.75 9.75h16.5m-16.5 0a2.25 2.25 0 0 1-2.25-2.25V5.25A2.25 2.25 0 0 1 3.75 3h16.5a2.25 2.25 0 0 1 2.25 2.25v2.25a2.25 2.25 0 0 1-2.25 2.25m-16.5 0v11.25c0 1.242 1.008 2.25 2.25 2.25h12c1.242 0 2.25-1.008 2.25-2.25V9.75" />
        </svg>
        <span class="text-xs font-medium">Orders</span>
      </a>
      }
      @if(shouldShowMoreTab()) {
      <div class="relative flex flex-col items-center justify-center w-full h-full pt-2 text-center">
        <button (click)="toggleMobileMoreMenu()"
          class="flex flex-col items-center w-full h-full cursor-pointer transition-colors duration-200 hover:text-primary"
          [class.text-primary]="isMoreViewActive() || showMobileMoreMenu()"
          [class.text-text-muted]="!isMoreViewActive() && !showMobileMoreMenu()"
          [class.dark:text-text-muted-dark]="!isMoreViewActive() && !showMobileMoreMenu()">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mb-1" fill="none" viewBox="0 0 24 24"
            stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
          </svg>
          <span class="text-xs font-medium">More</span>
        </button>

        @if(showMobileMoreMenu()) {
        <div
          class="absolute bottom-full right-0 mb-3 w-56 origin-bottom-right bg-card dark:bg-card-dark rounded-md shadow-2xl ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
          <div class="py-2" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
            @if (userService.hasPermission('viewReports')) {
            <a (click)="setView('reports')"
              class="flex items-center px-4 py-3 text-sm font-medium hover:bg-secondary dark:hover:bg-base-dark transition-colors duration-200 cursor-pointer"
              [class.text-primary]="currentView() === 'reports'"
              [class.dark:text-text-dark]="currentView() === 'reports'"
              [class.text-text-muted]="currentView() !== 'reports'"
              [class.dark:text-text-muted-dark]="currentView() !== 'reports'">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24"
                stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
              </svg>
              Reports
            </a>
            }
            @if (userService.hasPermission('viewLogs')) {
            <a (click)="setView('logs')"
              class="flex items-center px-4 py-3 text-sm font-medium hover:bg-secondary dark:hover:bg-base-dark transition-colors duration-200 cursor-pointer"
              [class.text-primary]="currentView() === 'logs'" [class.dark:text-text-dark]="currentView() === 'logs'"
              [class.text-text-muted]="currentView() !== 'logs'"
              [class.dark:text-text-muted-dark]="currentView() !== 'logs'">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24"
                stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" />
              </svg>
              Audit Logs
            </a>
            }
            @if (userService.hasPermission('manageSettings')) {
            <a (click)="setView('settings')"
              class="flex items-center px-4 py-3 text-sm font-medium hover:bg-secondary dark:hover:bg-base-dark transition-colors duration-200 cursor-pointer"
              [class.text-primary]="currentView() === 'settings'"
              [class.dark:text-text-dark]="currentView() === 'settings'"
              [class.text-text-muted]="currentView() !== 'settings'"
              [class.dark:text-text-muted-dark]="currentView() !== 'settings'">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24"
                stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" />
              </svg>
              Settings
            </a>
            }
          </div>
        </div>
        }
      </div>
      }
    </div>
  </nav>

  @if(showMobileMoreMenu()) {
  <div (click)="showMobileMoreMenu.set(false)" class="fixed inset-0 z-30 md:hidden"></div>
  }

  @if(showRoleModal()) {
  <app-role-switcher-modal [targetRole]="pendingRole()" (close)="showRoleModal.set(false)"
    (roleAuthenticated)="onRoleAuthenticated($event)"></app-role-switcher-modal>
  }
  }
</div>