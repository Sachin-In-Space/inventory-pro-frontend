<div class="space-y-6">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <h2 class="text-3xl font-bold text-text-main dark:text-text-dark">Orders</h2>
    @if(userService.hasPermission('createOrders')) {
    <button (click)="openModal()"
      class="flex items-center justify-center gap-2 px-4 py-2 bg-primary text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-75 transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd"
          d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
          clip-rule="evenodd" />
      </svg>
      Create Order
    </button>
    }
  </div>

  <!-- Filter Toggle for Mobile -->
  <button (click)="toggleFilters()"
    class="md:hidden w-full flex items-center justify-between p-3 bg-card dark:bg-card-dark rounded-lg shadow-sm text-left focus:outline-none focus:ring-2 focus:ring-primary border border-border-light dark:border-border-dark">
    <div class="flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-text-muted" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd"
          d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z"
          clip-rule="evenodd" />
      </svg>
      <span class="font-semibold text-text-main dark:text-text-dark">Filters</span>
    </div>
    <svg class="w-5 h-5 text-text-muted transition-transform duration-200" [class.rotate-180]="showFilters()"
      xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  <!-- Filters -->
  <div class="flex flex-col md:flex-row gap-4 mb-6" [class.hidden]="!showFilters()">
    <div class="flex-1">
      <label for="search" class="block text-sm font-medium text-text-muted dark:text-text-muted-dark mb-1">Search
        Order</label>
      <input type="text" id="search" [value]="orderSearchTerm()" (input)="onSearchTermChange($event)"
        class="w-full px-4 py-2 bg-card dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all"
        placeholder="Search by ID, customer name or phone...">
    </div>
    <div>
      <label for="status"
        class="block text-sm font-medium text-text-muted dark:text-text-muted-dark mb-1">Status</label>
      <select id="status" [value]="filterStatus()" (change)="onStatusChange($event)"
        class="w-full md:w-48 px-4 py-2 bg-card dark:bg-card-dark border border-border-light dark:border-border-dark rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all">
        <option value="all">All Statuses</option>
        <option value="ORDER-CREATED">Order Created</option>
        <option value="IN-DELIVERY">In Delivery</option>
        <option value="DELIVERED">Delivered</option>
        <option value="CANCELLED">Cancelled</option>
      </select>
    </div>
    <div class="md:col-span-1">
      <label class="text-sm font-medium text-text-muted dark:text-text-muted-dark">Date Range</label>
      <div class="flex items-center gap-2 mt-1">
        <input id="date-from" type="date" [value]="filterDateFrom()"
          (input)="filterDateFrom.set($any($event.target).value)"
          class="block w-full px-3 py-2 bg-card dark:bg-card-dark border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
        <span class="text-text-muted">-</span>
        <input id="date-to" type="date" [value]="filterDateTo()" (input)="filterDateTo.set($any($event.target).value)"
          class="block w-full px-3 py-2 bg-card dark:bg-card-dark border border-border-light dark:border-border-dark rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
      </div>
    </div>
    <div class="md:col-span-1 flex items-end justify-end">
      @if (isAnyFilterActive()) {
      <button (click)="clearFilters()" class="text-sm font-medium text-primary hover:underline">Clear All
        Filters</button>
      }
    </div>
  </div>


  <!-- Orders List -->
  <div
    class="bg-card dark:bg-card-dark shadow-sm rounded-xl overflow-x-auto border border-border-light dark:border-border-dark">
    <!-- Desktop Table -->
    <table class="w-full text-sm text-left text-text-muted dark:text-text-muted-dark hidden md:table">
      <thead class="text-xs uppercase bg-secondary dark:bg-base-dark">
        <tr>
          <th scope="col" class="px-6 py-3 font-medium">Order ID</th>
          <th scope="col" class="px-6 py-3 font-medium">Customer</th>
          <th scope="col" class="px-6 py-3 font-medium">Total</th>
          <th scope="col" class="px-6 py-3 font-medium">Status</th>
          <th scope="col" class="px-6 py-3 font-medium">Created At</th>
          <th scope="col" class="px-6 py-3 text-right font-medium">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-border-light dark:divide-border-dark">
        @for (order of orderService.orders(); track order.id) {
        <tr
          class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors border-b border-border-light dark:border-border-dark last:border-0"
          [ngClass]="{
            'bg-blue-50': viewingOrder()?.id === order.id,
            'dark:bg-blue-900/20': viewingOrder()?.id === order.id
          }">
          <td class="px-6 py-4 font-medium text-text-main dark:text-text-dark">#{{ order.id }}</td>
          <td class="px-6 py-4">
            <div class="font-semibold text-text-main dark:text-text-dark">{{ order.customerName }}</div>
            <div class="text-xs">{{ order.customerPhone }}</div>
          </td>
          <td class="px-6 py-4 font-semibold text-text-main dark:text-text-dark">{{ order.totalAmount |
            currency:'INR':'symbol-narrow' }}</td>
          <td class="px-6 py-4">
            <span class="px-2 py-1 text-xs font-medium rounded-full" [class]="getStatusColor(order.status)">
              {{ order.status }}
            </span>
          </td>
          <td class="px-6 py-4">{{ order.createdAt | date:'short' }}</td>
          <td class="px-6 py-4 text-right space-x-4">
            <button (click)="viewingOrder.set(order)" class="font-medium text-primary hover:underline">View</button>
            @if (userService.hasPermission('updateOrderStatus') && order.status === 'ORDER-CREATED') {
            <button (click)="updateStatus(order, 'IN-DELIVERY')"
              class="font-medium text-yellow-600 dark:text-yellow-500 hover:underline">Start Delivery</button>
            }
            @if (userService.hasPermission('updateOrderStatus') && order.status === 'IN-DELIVERY') {
            <button (click)="updateStatus(order, 'DELIVERED')"
              class="font-medium text-green-600 dark:text-green-500 hover:underline">Mark Delivered</button>
            }
            @if (userService.hasPermission('manageOrders')) {
            <button (click)="deleteOrder(order)"
              class="font-medium text-red-600 dark:text-red-500 hover:underline">Delete</button>
            }
          </td>
        </tr>
        } @empty {
        <tr>
          <td colspan="6" class="px-6 py-12 text-center text-text-muted dark:text-text-muted-dark">
            No orders found matching your criteria.
          </td>
        </tr>
        }
      </tbody>
    </table>
    <!-- Mobile Cards -->
    <div class="md:hidden divide-y divide-border-light dark:divide-border-dark">
      @for (order of orderService.orders(); track order.id) {
      <div class="p-4 space-y-3">
        <div class="flex justify-between items-start">
          <div>
            <p class="font-semibold text-text-main dark:text-text-dark">Order #{{ order.id }}</p>
            <p class="text-sm text-text-muted">{{ order.customerName }}</p>
            <p class="text-xs text-text-muted">{{ order.createdAt | date:'short' }}</p>
          </div>
          <span class="px-2 py-1 text-xs font-medium rounded-full" [class]="getStatusColor(order.status)">
            {{ order.status }}
          </span>
        </div>
        <div class="flex justify-between items-center">
          <p class="text-lg font-bold text-text-main dark:text-text-dark">{{ order.totalAmount |
            currency:'INR':'symbol-narrow' }}</p>
          <div class="flex gap-2 flex-wrap justify-end">
            <button (click)="viewingOrder.set(order)"
              class="font-medium text-sm text-primary hover:underline">View</button>
            @if (userService.hasPermission('updateOrderStatus') && order.status === 'ORDER-CREATED') {
            <button (click)="updateStatus(order, 'IN-DELIVERY')"
              class="font-medium text-sm text-yellow-600 dark:text-yellow-500 hover:underline">Start Delivery</button>
            }
            @if (userService.hasPermission('updateOrderStatus') && order.status === 'IN-DELIVERY') {
            <button (click)="updateStatus(order, 'DELIVERED')"
              class="font-medium text-sm text-green-600 dark:text-green-500 hover:underline">Mark Delivered</button>
            }
            @if (userService.hasPermission('manageOrders')) {
            <button (click)="deleteOrder(order)"
              class="font-medium text-sm text-red-600 dark:text-red-500 hover:underline">Delete</button>
            }
          </div>
        </div>
      </div>
      } @empty {
      <p class="px-6 py-12 text-center text-text-muted dark:text-text-muted-dark">
        No orders found matching your criteria.
      </p>
      }
    </div>
  </div>
</div>

<!-- Create Order Modal -->
@if (showModal()) {
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
  <div class="bg-card dark:bg-card-dark rounded-lg shadow-xl w-full max-w-2xl h-full md:h-[90vh] flex flex-col">
    <div class="flex items-center justify-between p-4 border-b border-border-light dark:border-border-dark">
      <h3 class="text-xl font-semibold text-text-main dark:text-text-dark">Create New Order</h3>
      <button (click)="closeModal()" class="text-text-muted hover:text-text-main dark:hover:text-text-dark">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Stepper Header -->
    <div class="p-4 border-b border-border-light dark:border-border-dark">
      <ol class="flex items-center w-full text-xs sm:text-sm">
        <li class="flex w-full items-center" [class.text-primary]="currentStep() >= 1"
          [class.dark:text-text-dark]="currentStep() >= 1">
          <span class="flex items-center justify-center w-8 h-8 rounded-full shrink-0"
            [class.bg-primary]="currentStep() >= 1" [class.text-white]="currentStep() >= 1"
            [class.bg-gray-200]="currentStep() < 1" [class.dark:bg-border-dark]="currentStep() < 1">1</span>
          <span class="ml-2 font-medium hidden sm:block">Products</span>
          <div class="w-full h-0.5 mx-2" [class.bg-primary]="currentStep() > 1" [class.bg-gray-200]="currentStep() <= 1"
            [class.dark:bg-border-dark]="currentStep() <= 1"></div>
        </li>
        <li class="flex w-full items-center" [class.text-primary]="currentStep() >= 2"
          [class.dark:text-text-dark]="currentStep() >= 2">
          <span class="flex items-center justify-center w-8 h-8 rounded-full shrink-0"
            [class.bg-primary]="currentStep() >= 2" [class.text-white]="currentStep() >= 2"
            [class.bg-gray-200]="currentStep() < 2" [class.dark:bg-border-dark]="currentStep() < 2">2</span>
          <span class="ml-2 font-medium hidden sm:block">Details</span>
          <div class="w-full h-0.5 mx-2" [class.bg-primary]="currentStep() > 2" [class.bg-gray-200]="currentStep() <= 2"
            [class.dark:bg-border-dark]="currentStep() <= 2"></div>
        </li>
        <li class="flex items-center" [class.text-primary]="currentStep() >= 3"
          [class.dark:text-text-dark]="currentStep() >= 3">
          <span class="flex items-center justify-center w-8 h-8 rounded-full shrink-0"
            [class.bg-primary]="currentStep() >= 3" [class.text-white]="currentStep() >= 3"
            [class.bg-gray-200]="currentStep() < 3" [class.dark:bg-border-dark]="currentStep() < 3">3</span>
          <span class="ml-2 font-medium hidden sm:block">Review</span>
        </li>
      </ol>
    </div>

    <!-- Stepper Content -->
    <div class="flex-1 p-6 flex flex-col overflow-hidden">
      @switch (currentStep()) {
      @case (1) {
      <div class="flex flex-col h-full">
        <div class="flex-shrink-0 mb-4">
          <app-input [control]="productSearchCtrl" label="Search by product name"></app-input>
        </div>
        <div class="flex-1 space-y-2 overflow-y-auto pr-2 custom-scrollbar">
          @for(product of availableProducts(); track product.id) {
          <div class="p-2 rounded-md hover:bg-secondary dark:hover:bg-base-dark">
            <div class="flex items-start gap-3">
              <img [src]="product.imageUrl || 'https://placehold.co/100x100?text=No+Image'" alt="{{product.name}}"
                class="w-12 h-12 rounded-md object-cover flex-shrink-0" />
              <div class="flex-1">
                <div class="flex justify-between items-start">
                  <div>
                    <p class="font-semibold text-sm leading-tight text-text-main dark:text-text-dark">{{ product.name }}
                    </p>
                    @if (getSelectedVariantByUnit(product); as selectedVariant) {
                    @if(getAvailableStock(product, selectedVariant); as stock) {
                    <p class="text-xs text-text-muted dark:text-text-muted-dark mt-0.5">
                      Stock Available: <span class="font-medium" [class.text-red-500]="stock === 0"
                        [class.text-yellow-500]="stock > 0 && stock <= 10" [class.text-green-600]="stock > 10">{{ stock
                        }}</span>
                    </p>
                    }
                    }
                  </div>
                  @if (getSelectedVariantByUnit(product); as selectedVariant) {
                  @if (cartItemMap().get(product.id + '-' + selectedVariant.unit); as cartItem) {
                  <div class="flex items-center gap-1.5 justify-self-end">
                    <button (click)="decrementCartItem(product)"
                      class="p-1.5 rounded-full bg-gray-200 dark:bg-border-dark hover:bg-gray-300 dark:hover:bg-opacity-80">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                      </svg>
                    </button>
                    <span class="w-6 text-center text-sm font-semibold">{{ cartItem.quantity }}</span>
                    <button (click)="addToCart(product)"
                      [disabled]="cartItem.quantity >= getAvailableStock(product, selectedVariant)"
                      class="p-1.5 rounded-full bg-gray-200 dark:bg-border-dark hover:bg-gray-300 dark:hover:bg-opacity-80 disabled:opacity-50 disabled:cursor-not-allowed">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                      </svg>
                    </button>
                  </div>
                  } @else {
                  <button (click)="addToCart(product)" [disabled]="getAvailableStock(product, selectedVariant) === 0"
                    class="p-2 text-primary rounded-full hover:bg-primary/10 disabled:text-gray-400 disabled:bg-transparent disabled:cursor-not-allowed justify-self-end">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd"
                        d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
                        clip-rule="evenodd" />
                    </svg>
                  </button>
                  }
                  }
                </div>
                <div class="pt-2">
                  <div class="flex items-center gap-1 flex-wrap">
                    @for(variant of product.variants; track variant.unit) {
                    <button (click)="selectUnit(product.id, variant.unit)"
                      [class.bg-primary]="selectedUnits()[product.id] === variant.unit && getAvailableStock(product, variant) > 0"
                      [class.text-white]="selectedUnits()[product.id] === variant.unit && getAvailableStock(product, variant) > 0"
                      [class.bg-gray-200]="selectedUnits()[product.id] !== variant.unit || getAvailableStock(product, variant) === 0"
                      [class.dark:bg-border-dark]="selectedUnits()[product.id] !== variant.unit || getAvailableStock(product, variant) === 0"
                      [class.line-through]="getAvailableStock(product, variant) === 0"
                      class="px-2 py-0.5 text-xs rounded-full border border-transparent disabled:opacity-50 disabled:cursor-not-allowed disabled:text-text-muted-dark"
                      [disabled]="getAvailableStock(product, variant) === 0">
                      {{ variant.unit }} - {{ variant.sellingPrice | currency:'INR':'symbol-narrow':'1.0-0' }}
                    </button>
                    }
                  </div>
                </div>
              </div>
            </div>
          </div>
          } @empty {
          <p class="text-center text-text-muted py-8">No products available.</p>
          }
        </div>
        @if (cart().length > 0) {
        <div class="mt-4 pt-4 border-t border-border-light dark:border-border-dark flex-shrink-0">
          <button (click)="toggleCartVisibility()"
            class="w-full flex justify-between items-center p-2 rounded-md hover:bg-secondary dark:hover:bg-base-dark">
            <span class="font-semibold">{{ cart().length }} {{ cart().length === 1 ? 'item' : 'items' }} in cart</span>
            <div class="flex items-center gap-2">
              <span class="font-semibold">{{ cartTotal() | currency:'INR':'symbol-narrow' }}</span>
              <svg class="w-5 h-5 transition-transform duration-200" [class.rotate-180]="showCartInStep1()" fill="none"
                stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
          </button>
          @if (showCartInStep1()) {
          <div class="mt-2 space-y-2 max-h-32 overflow-y-auto pr-2">
            @for(item of cart(); track item.productId+item.variantUnit) {
            <div class="flex items-center justify-between p-2 rounded-md bg-secondary dark:bg-base-dark">
              <div>
                <p class="font-medium text-sm">{{ item.productName }} ({{ item.variantUnit }})</p>
                <p class="text-xs text-text-muted">{{ item.quantity }} x {{ item.price | currency:'INR':'symbol-narrow'
                  }}</p>
              </div>
              <button (click)="removeFromCart(item.productId, item.variantUnit)"
                class="p-1 text-red-500 rounded-full hover:bg-red-100">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                  </path>
                </svg>
              </button>
            </div>
            }
          </div>
          }
        </div>
        }
      </div>
      }
      @case (2) {
      <form [formGroup]="customerForm" class="h-full overflow-y-auto">
        <h4 class="font-semibold mb-4">Customer Details</h4>
        <div class="space-y-6">
          <div class="relative" (focusout)="hideSuggestions()">
            <app-input [control]="customerNameCtrl" label="Customer Name"
              (focus)="showCustomerSuggestions.set(true)"></app-input>
            @if (showCustomerSuggestions() && suggestedCustomers().length > 0) {
            <div
              class="absolute z-10 w-full mt-1 bg-card dark:bg-card-dark border border-border-light dark:border-border-dark rounded-md shadow-lg max-h-48 overflow-y-auto custom-scrollbar">
              @for(customer of suggestedCustomers(); track customer.id) {
              <div (click)="selectCustomer(customer)"
                class="px-4 py-2 text-sm text-text-main dark:text-text-dark hover:bg-secondary dark:hover:bg-base-dark cursor-pointer">
                <p class="font-semibold">{{ customer.customerName }}</p>
                <p class="text-xs text-text-muted">{{ customer.customerPhone }}</p>
              </div>
              }
            </div>
            }
          </div>
          <app-input [control]="customerAddressCtrl" label="Address"></app-input>
          <div>
            <app-input [control]="customerPhoneCtrl" label="Phone" type="tel"></app-input>
            @if (customerPhoneCtrl.invalid && customerPhoneCtrl.touched) {
            <p class="mt-1 text-xs text-red-600 dark:text-red-400">
              Please enter a valid 10-digit phone number.
            </p>
            }
          </div>
        </div>
      </form>
      }
      @case (3) {
      <div class="flex flex-col h-full">
        <div class="flex-1 overflow-y-auto pr-2 custom-scrollbar">
          <div class="space-y-6">
            <div>
              <h4
                class="font-semibold text-text-main dark:text-text-dark mb-2 border-b border-border-light dark:border-border-dark pb-1">
                Customer Details</h4>
              <div class="text-sm space-y-1">
                <p><strong class="text-text-muted w-20 inline-block">Name:</strong> {{ customerForm.value.customerName
                  }}</p>
                <p><strong class="text-text-muted w-20 inline-block">Address:</strong> {{
                  customerForm.value.customerAddress }}</p>
                <p><strong class="text-text-muted w-20 inline-block">Phone:</strong> {{ customerForm.value.customerPhone
                  }}</p>
              </div>
            </div>
            <div>
              <h4
                class="font-semibold text-text-main dark:text-text-dark mb-2 border-b border-border-light dark:border-border-dark pb-1">
                Order Items ({{cart().length}})</h4>
              <div class="space-y-3">
                @for(item of cart(); track item.productId + item.variantUnit) {
                <div class="flex justify-between items-center">
                  <div class="min-w-0">
                    <p class="font-medium text-sm text-text-main dark:text-text-dark">{{ item.productName }}</p>
                    <p class="text-xs text-text-muted">{{ item.variantUnit }} &times; {{ item.quantity }}</p>
                  </div>
                  <div class="flex-shrink-0">
                    <p class="font-semibold text-right text-sm">{{ (item.quantity * item.price) |
                      currency:'INR':'symbol-narrow' }}</p>
                  </div>
                </div>
                }
              </div>
            </div>
          </div>
        </div>
        <div class="flex-shrink-0 mt-4 pt-4 border-t border-border-light dark:border-border-dark">
          <div class="flex justify-between items-center text-lg font-bold">
            <span>Total</span>
            <span>{{ cartTotal() | currency:'INR':'symbol-narrow' }}</span>
          </div>
        </div>
      </div>
      }
      }
    </div>

    <!-- Stepper Footer -->
    <div
      class="p-4 bg-secondary dark:bg-base-dark border-t border-border-light dark:border-border-dark flex items-center"
      [class.justify-between]="currentStep() > 1" [class.justify-end]="currentStep() === 1">
      @if (currentStep() > 1) {
      <button (click)="prevStep()"
        class="px-4 py-2 bg-gray-200 text-gray-800 dark:bg-border-dark dark:text-text-dark rounded-lg hover:bg-gray-300">Back</button>
      }
      @if (currentStep() === 1) {
      <div class="flex-1 text-right">
        <span class="mr-4 text-lg font-bold">{{ cartTotal() | currency:'INR':'symbol-narrow' }}</span>
        <button (click)="nextStep()" [disabled]="cart().length === 0"
          class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 disabled:bg-opacity-50 disabled:cursor-not-allowed">
          Next
        </button>
      </div>
      }
      @if (currentStep() === 2) {
      <button (click)="nextStep()" [disabled]="customerForm.invalid"
        class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 disabled:bg-opacity-50 disabled:cursor-not-allowed">
        Review Order
      </button>
      }
      @if (currentStep() === 3) {
      <button (click)="createOrder()" [disabled]="customerForm.invalid || cart().length === 0"
        class="w-full sm:w-auto px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 disabled:bg-opacity-50 disabled:cursor-not-allowed">
        Place Order
      </button>
      }
    </div>
  </div>
</div>
}


<!-- Order Detail Modal -->
@if (viewingOrder(); as order) {
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
  <div class="bg-card dark:bg-card-dark rounded-lg shadow-xl w-full max-w-2xl max-h-full flex flex-col">
    <div class="flex items-center justify-between p-4 border-b border-border-light dark:border-border-dark">
      <h3 class="text-xl font-semibold text-text-main dark:text-text-dark">Order #{{ order.id }} Details</h3>
      <button (click)="viewingOrder.set(null)" class="text-text-muted hover:text-text-main dark:hover:text-text-dark">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    <div class="p-6 space-y-6 overflow-y-auto">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
        <div>
          <h4
            class="font-semibold text-text-main dark:text-text-dark mb-2 border-b border-border-light dark:border-border-dark pb-1">
            Customer Details</h4>
          <p><strong class="text-text-muted">Name:</strong> {{ order.customerName }}</p>
          <p><strong class="text-text-muted">Address:</strong> {{ order.customerAddress }}</p>
          <p><strong class="text-text-muted">Phone:</strong> {{ order.customerPhone }}</p>
        </div>
        <div>
          <h4
            class="font-semibold text-text-main dark:text-text-dark mb-2 border-b border-border-light dark:border-border-dark pb-1">
            Order Summary</h4>
          <p><strong class="text-text-muted">Status:</strong> <span class="px-2 py-1 text-xs font-medium rounded-full"
              [class]="getStatusColor(order.status)">{{ order.status }}</span></p>
          <p><strong class="text-text-muted">Created At:</strong> {{ order.createdAt | date:'medium' }}</p>
          <p><strong class="text-text-muted">Created By:</strong> {{ order.createdBy }}</p>
          <p class="text-lg mt-2"><strong class="text-text-muted">Total:</strong> <span class="font-bold">{{
              order.totalAmount | currency:'INR':'symbol-narrow' }}</span></p>
        </div>
      </div>
      <div>
        <h4
          class="font-semibold text-text-main dark:text-text-dark mb-2 border-b border-border-light dark:border-border-dark pb-1">
          Items Ordered</h4>
        <div class="space-y-2">
          @for(item of order.items; track item.productId + item.variantUnit) {
          <div class="flex justify-between items-center p-2 bg-secondary dark:bg-base-dark rounded-md">
            <div>
              <p class="font-medium">{{ item.productName }} <span class="text-xs text-text-muted">({{ item.variantUnit
                  }})</span></p>
              <p class="text-sm text-text-main dark:text-text-muted">{{ item.quantity }} x {{ item.price |
                currency:'INR':'symbol-narrow' }}</p>
            </div>
            <p class="font-semibold">{{ (item.quantity * item.price) | currency:'INR':'symbol-narrow' }}</p>
          </div>
          }
        </div>
      </div>
    </div>
    <div
      class="p-4 bg-secondary dark:bg-base-dark border-t border-border-light dark:border-border-dark flex justify-end">
      <button (click)="viewingOrder.set(null)"
        class="px-4 py-2 bg-primary text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-75">Close</button>
    </div>
  </div>
</div>
}

<!-- Snackbar -->
@if (showSnackbar()) {
<div
  class="fixed top-8 right-8 z-50 bg-green-600 text-white px-5 py-3 rounded-lg shadow-xl text-sm font-semibold animate-fade-in-out">
  <div class="flex items-center gap-2">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <span>{{ snackbarMessage() }}</span>
  </div>
</div>
}

<style>
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
    margin-block: 4px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: #d1d5db;
    /* gray-300 */
    border-radius: 10px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background-color: #9ca3af;
    /* gray-400 */
  }

  .dark .custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: #4b5563;
    /* gray-600 */
  }

  .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background-color: #6b7280;
    /* gray-500 */
  }

  @keyframes fade-in-out {
    0% {
      opacity: 0;
      transform: translateY(-20px);
    }

    10%,
    90% {
      opacity: 1;
      transform: translateY(0);
    }

    100% {
      opacity: 0;
      transform: translateY(-20px);
    }
  }

  .animate-fade-in-out {
    animation: fade-in-out 3s ease-in-out forwards;
  }
</style>